<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Hydration Bugs</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../01_introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../02_getting_started.html"><strong aria-hidden="true">2.</strong> Getting Started</a></li><li class="chapter-item expanded "><a href="../view/index.html"><strong aria-hidden="true">3.</strong> Building User Interfaces</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../view/01_basic_component.html"><strong aria-hidden="true">3.1.</strong> A Basic Component</a></li><li class="chapter-item expanded "><a href="../view/02_dynamic_attributes.html"><strong aria-hidden="true">3.2.</strong> Dynamic Attributes</a></li><li class="chapter-item expanded "><a href="../view/03_components.html"><strong aria-hidden="true">3.3.</strong> Components and Props</a></li><li class="chapter-item expanded "><a href="../view/04_iteration.html"><strong aria-hidden="true">3.4.</strong> Iteration</a></li><li class="chapter-item expanded "><a href="../view/05_forms.html"><strong aria-hidden="true">3.5.</strong> Forms and Inputs</a></li><li class="chapter-item expanded "><a href="../view/06_control_flow.html"><strong aria-hidden="true">3.6.</strong> Control Flow</a></li><li class="chapter-item expanded "><a href="../view/07_errors.html"><strong aria-hidden="true">3.7.</strong> Error Handling</a></li><li class="chapter-item expanded "><a href="../view/08_parent_child.html"><strong aria-hidden="true">3.8.</strong> Parent-Child Communication</a></li><li class="chapter-item expanded "><a href="../view/09_component_children.html"><strong aria-hidden="true">3.9.</strong> Passing Children to Components</a></li></ol></li><li class="chapter-item expanded "><a href="../reactivity/index.html"><strong aria-hidden="true">4.</strong> Reactivity</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../reactivity/working_with_signals.html"><strong aria-hidden="true">4.1.</strong> Working with Signals</a></li><li class="chapter-item expanded "><a href="../reactivity/14_create_effect.html"><strong aria-hidden="true">4.2.</strong> Responding to Changes with create_effect</a></li><li class="chapter-item expanded "><a href="../reactivity/interlude_functions.html"><strong aria-hidden="true">4.3.</strong> Interlude: Reactivity and Functions</a></li></ol></li><li class="chapter-item expanded "><a href="../testing.html"><strong aria-hidden="true">5.</strong> Testing</a></li><li class="chapter-item expanded "><a href="../async/index.html"><strong aria-hidden="true">6.</strong> Async</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../async/10_resources.html"><strong aria-hidden="true">6.1.</strong> Loading Data with Resources</a></li><li class="chapter-item expanded "><a href="../async/11_suspense.html"><strong aria-hidden="true">6.2.</strong> Suspense</a></li><li class="chapter-item expanded "><a href="../async/12_transition.html"><strong aria-hidden="true">6.3.</strong> Transition</a></li><li class="chapter-item expanded "><a href="../async/13_actions.html"><strong aria-hidden="true">6.4.</strong> Actions</a></li></ol></li><li class="chapter-item expanded "><a href="../interlude_projecting_children.html"><strong aria-hidden="true">7.</strong> Interlude: Projecting Children</a></li><li class="chapter-item expanded "><a href="../15_global_state.html"><strong aria-hidden="true">8.</strong> Global State Management</a></li><li class="chapter-item expanded "><a href="../router/index.html"><strong aria-hidden="true">9.</strong> Router</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../router/16_routes.html"><strong aria-hidden="true">9.1.</strong> Defining &lt;Routes/&gt;</a></li><li class="chapter-item expanded "><a href="../router/17_nested_routing.html"><strong aria-hidden="true">9.2.</strong> Nested Routing</a></li><li class="chapter-item expanded "><a href="../router/18_params_and_queries.html"><strong aria-hidden="true">9.3.</strong> Params and Queries</a></li><li class="chapter-item expanded "><a href="../router/19_a.html"><strong aria-hidden="true">9.4.</strong> &lt;A/&gt;</a></li><li class="chapter-item expanded "><a href="../router/20_form.html"><strong aria-hidden="true">9.5.</strong> &lt;Form/&gt;</a></li></ol></li><li class="chapter-item expanded "><a href="../interlude_styling.html"><strong aria-hidden="true">10.</strong> Interlude: Styling</a></li><li class="chapter-item expanded "><a href="../metadata.html"><strong aria-hidden="true">11.</strong> Metadata</a></li><li class="chapter-item expanded "><a href="../ssr/index.html"><strong aria-hidden="true">12.</strong> Server Side Rendering</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../ssr/21_cargo_leptos.html"><strong aria-hidden="true">12.1.</strong> cargo-leptos</a></li><li class="chapter-item expanded "><a href="../ssr/22_life_cycle.html"><strong aria-hidden="true">12.2.</strong> The Life of a Page Load</a></li><li class="chapter-item expanded "><a href="../ssr/23_ssr_modes.html"><strong aria-hidden="true">12.3.</strong> Async Rendering and SSR “Modes”</a></li><li class="chapter-item expanded "><a href="../ssr/24_hydration_bugs.html" class="active"><strong aria-hidden="true">12.4.</strong> Hydration Bugs</a></li></ol></li><li class="chapter-item expanded "><a href="../server/index.html"><strong aria-hidden="true">13.</strong> Working with the Server</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../server/25_server_functions.html"><strong aria-hidden="true">13.1.</strong> Server Functions</a></li><li class="chapter-item expanded "><a href="../server/26_extractors.html"><strong aria-hidden="true">13.2.</strong> Extractors</a></li><li class="chapter-item expanded "><a href="../server/27_response.html"><strong aria-hidden="true">13.3.</strong> Responses and Redirects</a></li></ol></li><li class="chapter-item expanded "><a href="../progressive_enhancement/index.html"><strong aria-hidden="true">14.</strong> Progressive Enhancement and Graceful Degradation</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../progressive_enhancement/action_form.html"><strong aria-hidden="true">14.1.</strong> &lt;ActionForm/&gt;s</a></li></ol></li><li class="chapter-item expanded "><a href="../deployment.html"><strong aria-hidden="true">15.</strong> Deployment</a></li><li class="chapter-item expanded "><a href="../appendix_reactive_graph.html"><strong aria-hidden="true">16.</strong> Appendix: How Does the Reactive System Work?</a></li><li class="chapter-item expanded "><a href="../appendix_binary_size.html"><strong aria-hidden="true">17.</strong> Appendix: Optimizing WASM Binary Size</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title"></h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="hydration-bugs-and-how-to-avoid-them"><a class="header" href="#hydration-bugs-and-how-to-avoid-them">Hydration Bugs <em>(and how to avoid them)</em></a></h1>
<h2 id="a-thought-experiment"><a class="header" href="#a-thought-experiment">A Thought Experiment</a></h2>
<p>Let’s try an experiment to test your intuitions. Open up an app you’re server-rendering with <code>cargo-leptos</code>. (If you’ve just been using <code>trunk</code> so far to play with examples, go <a href="./21_cargo_leptos.html">clone a <code>cargo-leptos</code> template</a> just for the sake of this exercise.)</p>
<p>Put a log somewhere in your root component. (I usually call mine <code>&lt;App/&gt;</code>, but anything will do.)</p>
<pre><code class="language-rust">#[component]
pub fn App(cx: Scope) -&gt; impl IntoView {
	leptos::log!(&quot;where do I run?&quot;);
	// ... whatever
}</code></pre>
<p>And let’s fire it up</p>
<pre><code class="language-bash">cargo leptos watch
</code></pre>
<p>Where do you expect <code>where do I run?</code> to log?</p>
<ul>
<li>In the command line where you’re running the server?</li>
<li>In the browser console when you load the page?</li>
<li>Neither?</li>
<li>Both?</li>
</ul>
<p>Try it out.</p>
<p>...</p>
<p>...</p>
<p>...</p>
<p>Okay, consider the spoiler alerted.</p>
<p>You’ll notice of course that it logs in both places, assuming everything goes according to plan. In fact on the server it logs twice—first during the initial server startup, when Leptos renders your app once to extract the route tree, then a second time when you make a request. Each time you reload the page, <code>where do I run?</code> should log once on the server and once on the client.</p>
<p>If you think about the description in the last couple sections, hopefully this makes sense. Your application runs once on the server, where it builds up a tree of HTML which is sent to the client. During this initial render, <code>where do I run?</code> logs on the server.</p>
<p>Once the WASM binary has loaded in the browser, your application runs a second time, walking over the same user interface tree and adding interactivity.</p>
<blockquote>
<p>Does that sound like a waste? It is, in a sense. But reducing that waste is a genuinely hard problem. It’s what some JS frameworks like Qwik are intended to solve, although it’s probably too early to tell whether it’s a net performance gain as opposed to other approaches.</p>
</blockquote>
<h2 id="the-potential-for-bugs"><a class="header" href="#the-potential-for-bugs">The Potential for Bugs</a></h2>
<p>Okay, hopefully all of that made sense. But what does it have to do with the title of this chapter, which is “Hydration bugs (and how to avoid them)”?</p>
<p>Remember that the application needs to run on both the server and the client. This generates a few different sets of potential issues you need to know how to avoid.</p>
<h3 id="mismatches-between-server-and-client-code"><a class="header" href="#mismatches-between-server-and-client-code">Mismatches between server and client code</a></h3>
<p>One way to create a bug is by creating a mismatch between the HTML that’s sent down by the server and what’s rendered on the client. It’s actually fairly hard to do this unintentionally, I think (at least judging by the bug reports I get from people.) But imagine I do something like this</p>
<pre><code class="language-rust">#[component]
pub fn App(cx: Scope) -&gt; impl IntoView {
    let data = if cfg!(target_arch = &quot;wasm32&quot;) {
        vec![0, 1, 2]
    } else {
        vec![]
    };
    data.into_iter()
        .map(|value| view! { cx, &lt;span&gt;{value}&lt;/span&gt; })
        .collect_view(cx)
}</code></pre>
<p>In other words, if this is being compiled to WASM, it has three items; otherwise it’s empty.</p>
<p>When I load the page in the browser, I see nothing. If I open the console I see a bunch of warnings:</p>
<pre><code>element with id 0-3 not found, ignoring it for hydration
element with id 0-4 not found, ignoring it for hydration
element with id 0-5 not found, ignoring it for hydration
component with id _0-6c not found, ignoring it for hydration
component with id _0-6o not found, ignoring it for hydration
</code></pre>
<p>The WASM version of your app, running in the browser, expects to find three items; but the HTML has none.</p>
<h4 id="solution"><a class="header" href="#solution">Solution</a></h4>
<p>It’s pretty rare that you do this intentionally, but it could happen from somehow running different logic on the server and in the browser. If you’re seeing warnings like this and you don’t think it’s your fault, it’s much more likely that it’s a bug with <code>&lt;Suspense/&gt;</code> or something. Feel free to go ahead and open an <a href="https://github.com/leptos-rs/leptos/issues">issue</a> or <a href="https://github.com/leptos-rs/leptos/discussions">discussion</a> on GitHub for help.</p>
<h3 id="mutating-the-dom-during-rendering"><a class="header" href="#mutating-the-dom-during-rendering">Mutating the DOM during rendering</a></h3>
<p>This is a slightly more common way to create a client/server mismatch: updating a signal <em>during rendering</em> in a way that mutates the view.</p>
<pre><code class="language-rust">#[component]
pub fn App(cx: Scope) -&gt; impl IntoView {
    let (loaded, set_loaded) = create_signal(cx, false);

    // create_effect only runs on the client
    create_effect(cx, move |_| {
        // do something like reading from localStorage
        set_loaded(true);
    });

    move || {
        if loaded() {
            view! { cx, &lt;p&gt;&quot;Hello, world!&quot;&lt;/p&gt; }.into_any()
        } else {
            view! { cx, &lt;div class=&quot;loading&quot;&gt;&quot;Loading...&quot;&lt;/div&gt; }.into_any()
        }
    }
}</code></pre>
<p>This one gives us the scary panic</p>
<pre><code>panicked at 'assertion failed: `(left == right)`
  left: `&quot;DIV&quot;`,
 right: `&quot;P&quot;`: SSR and CSR elements have the same hydration key but different node kinds.
</code></pre>
<p>And a handy link to this page!</p>
<p>The problem here is that <code>create_effect</code> runs <strong>immediately</strong> and <strong>synchronously</strong>, but only in the browser. As a result, on the server, <code>loaded</code> is false, and a <code>&lt;div&gt;</code> is rendered. But on the browser, by the time the view is being rendered, <code>loaded</code> has already been set to <code>true</code>, and the browser is expecting to find a <code>&lt;p&gt;</code>.</p>
<h4 id="solution-1"><a class="header" href="#solution-1">Solution</a></h4>
<p>You can simply tell the effect to wait a tick before updating the signal, by using something like <code>request_animation_frame</code>, which will set a short timeout and then update the signal before the next frame.</p>
<pre><code class="language-rust">create_effect(cx, move |_| {
    // do something like reading from localStorage
    request_animation_frame(move || set_loaded(true));
});</code></pre>
<p>This allows the browser to hydrate with the correct, matching state (<code>loaded</code> is <code>false</code> when it reaches the view), then immediately update it to <code>true</code> once hydration is complete.</p>
<h3 id="not-all-client-code-can-run-on-the-server"><a class="header" href="#not-all-client-code-can-run-on-the-server">Not all client code can run on the server</a></h3>
<p>Imagine you happily import a dependency like <code>gloo-net</code> that you’ve been used to using to make requests in the browser, and use it in a <code>create_resource</code> in a server-rendered app.</p>
<p>You’ll probably instantly see the dreaded message</p>
<pre><code>panicked at 'cannot call wasm-bindgen imported functions on non-wasm targets'
</code></pre>
<p>Uh-oh.</p>
<p>But of course this makes sense. We’ve just said that your app needs to run on the client and the server.</p>
<h4 id="solution-2"><a class="header" href="#solution-2">Solution</a></h4>
<p>There are a few ways to avoid this:</p>
<ol>
<li>Only use libraries that can run on both the server and the client. <code>reqwest</code>, for example, works for making HTTP requests in both settings.</li>
<li>Use different libraries on the server and the client, and gate them using the <code>#[cfg]</code> macro. (<a href="https://github.com/leptos-rs/leptos/blob/main/examples/hackernews/src/api.rs">Click here for an example</a>.)</li>
<li>Wrap client-only code in <code>create_effect</code>. Because <code>create_effect</code> only runs on the client, this can be an effective way to access browser APIs that are not needed for initial rendering.</li>
</ol>
<p>For example, say that I want to store something in the browser’s <code>localStorage</code> whenever a signal changes.</p>
<pre><code class="language-rust">#[component]
pub fn App(cx: Scope) -&gt; impl IntoView {
    use gloo_storage::Storage;
	let storage = gloo_storage::LocalStorage::raw();
	leptos::log!(&quot;{storage:?}&quot;);
}</code></pre>
<p>This panics because I can’t access <code>LocalStorage</code> during server rendering.</p>
<p>But if I wrap it in an effect...</p>
<pre><code class="language-rust">#[component]
pub fn App(cx: Scope) -&gt; impl IntoView {
    use gloo_storage::Storage;
    create_effect(cx, move |_| {
        let storage = gloo_storage::LocalStorage::raw();
		leptos::log!(&quot;{storage:?}&quot;);
    });
}</code></pre>
<p>It’s fine! This will render appropriately on the server, ignoring the client-only code, and then access the storage and log a message on the browser.</p>
<h3 id="not-all-server-code-can-run-on-the-client"><a class="header" href="#not-all-server-code-can-run-on-the-client">Not all server code can run on the client</a></h3>
<p>WebAssembly running in the browser is a pretty limited environment. You don’t have access to a file-system or to many of the other things the standard library may be used to having. Not every crate can even be compiled to WASM, let alone run in a WASM environment.</p>
<p>In particular, you’ll sometimes see errors about the crate <code>mio</code> or missing things from <code>core</code>. This is generally a sign that you are trying to compile something to WASM that can’t be compiled to WASM. If you’re adding server-only dependencies, you’ll want to mark them <code>optional = true</code> in your <code>Cargo.toml</code> and then enable them in the <code>ssr</code> feature definition. (Check out one of the template <code>Cargo.toml</code> files to see more details.)</p>
<p>You can use <code>create_effect</code> to specify that something should only run on the client, and not in the server. Is there a way to specify that something should run only on the server, and not the client?</p>
<p>In fact, there is. The next chapter will cover the topic of server functions in some detail. (In the meantime, you can check out their docs <a href="https://docs.rs/leptos_server/0.2.5/leptos_server/index.html">here</a>.)</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../ssr/23_ssr_modes.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../server/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../ssr/23_ssr_modes.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../server/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
